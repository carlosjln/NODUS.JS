/*!
 * NODUS.JS - v1.0.0
 * Front-End API for NODUS
 * https://github.com/carlosjln/NODUS.JS
 *
 * Author: Carlos J. Lopez
 * https://github.com/carlosjln
 */
(function(n,t){function r(){}function i(n){if(n instanceof i)return n;if(typeof n=="string")return new i({id:n});var t=this,r=n.id;return t instanceof i?(t.id=r,t):null}function rt(n){var t=n.id;if(u[t]instanceof i)return null;f[t]={data:!1,handlers:!1};u[t]=n}function ut(n,t){var r=u[n];return r instanceof i==!1?(console.log(new Error("The node { id='"+n+"' } cannot be updated.")),console.log(r),null):(r.name=t.name,r.caption=t.caption,r.parent_id=t.parent_id,d[n]=t,p(n,t.handlers),ft(n,t.actions),r)}function p(t,r){var f=u[t],e,o;if(f instanceof i==!1||r===null||r==="")return null;e={};o={node:f,handlers:e,shared:g};try{new Function("context","window",r)(o,n)}catch(s){throw s;}return h[t]=e,f}function ft(n,t){var r,e;if(t=t||[],r=u[n],e=t.length,r instanceof i==!1)return null;while(e--){var h=t[e],f=h.id,c=h.name,s=function(n){return function(t){o(n,null,t)}}(f),l={id:f,name:c,node_id:n,method:s};s.id=f;r[c]=s;a[f]=l}return r}function c(n,t,r){return(console.log("Validating node { id='"+n+"' }"),typeof n!="string")?(console.log(new Error("The [node id] must be a string GUID")),console.log("Instead received:",n),null):(rt(i(n)),et(n,t,r))}function et(n,t,i){var r=f[n]!==undefined&&f[n].data===!0,u=r?w:nt;return u(n,t,i)}function w(n,t,i){return(console.log("Validating node handlers { id='"+n+"' }"),f[n].handlers===!1)?tt(n,t,i):(y[n]=u[n],t(n,i))}function o(n,t,i){var v,f,d,g;if(n===null)return console.log("The action_id can't be null."),null;if(t=t||"",i=i||{},v=a[n],f=v.node_id,y[f]===null)return c(f,function(){o(n,t,i)});var l=v.name,p=h[f],u=p.actions[l]||{is_empty:!0},b=u.on_success,nt=u.before_request||function(){return!0},tt=u.get_query||function(){return""},w=u.on_exception||p.actions.on_exception||p.on_exception||e,k;if(u.is_empty)return console.log(new Error("The action '"+l+"' is not defined on the handler.")),!1;if(b===undefined)return console.log(new Error("The method 'Handle.action."+l+".on_success' is undefined.")),!1;try{k=nt.call(u,i)}catch(it){return w.call(u,it)}k&&(t=t||tt.call(u,i),d="query="+encodeURIComponent(r.encode_base64(t)),g={query:t,action_name:l,action_handler:u,on_success:b,on_exception:w},s({url:"action/"+n,method:"POST",send:d,context:g,before_request:ot,on_success:st,on_error:w}))}function ot(){console.log("Executing action '{"+this.action_name+"}' with params:",this.query||null)}function st(n){var i=r.parse_reply(n),t=this;if(i.has_errors())return t.on_exception.call(t.action_handler,i.exceptions);try{t.on_success.call(t.action_handler,i,t.data)}catch(u){t.on_exception.call(t.action_handler,new l(u))}}function s(n){n.url="node/"+n.url;n.on_error=n.on_error||e;r.request(n)}function e(n){console.log("ApplicationException: ",n)}function l(n){var t=this;n=typeof n=="string"?{message:n}:n;t.validation=[];t.application=[{name:"ApplicationException",message:n?n.message:""}]}function b(n){var r=n.target||n.srcElement||t,u=k(r,"node-id"),f=k(r,"action-id");(u||f)&&(n.preventDefault(),r.blur());u?i.view(u):f&&o(f)}function k(n,t){var i=n.getAttribute(t),r;return i===undefined&&(r=n.parentNode)&&(i=r.getAttribute(t)),i}var u={},d={},a={},h={},f={},g={},v={},y={},nt=function(){function n(n,u,o){(f[n]=f[n]||{data:!1,handlers:!1}).data=!0;var h={validate:c,node_id:n,callback:u,data:o,parse_reply:r.parse_reply};s({url:n,context:h,before_request:t,on_success:i,on_error:e})}function t(){console.log("Requesting data for node { id='"+this.node_id+"' }")}function i(n){var t=this,u=t.node_id,i=r.parse_reply(n);return i.has_errors()?t.exception_handler(i.exceptions):(ut(u,i.data),w(u,t.callback,t.data))}return n}(),tt=function(){function n(n,u,o){f[n].handlers=!0;var h={node_id:n,callback:u,data:o,parse_reply:r.parse_reply,exception_handler:e};s({url:n+"/handlers",context:h,before_request:t,on_success:i,on_error:e})}function t(){var n=u[this.node_id];console.log("Requesting action handlers for Node{ name="+n.name+" id="+n.id+" }")}function i(n){var t=this,i=t.parse_reply(n);return i.has_errors()?t.exception_handler(i.exceptions):(p(t.node_id,i.data),t.callback(t.node_id,t.data))}return n}(),it=function(){function f(t,r){var a=u[t],y=h[t],f=y.view||{is_empty:!0},c=f.on_exception||y.on_exception||e,w,p,b;if(f.is_empty)return p=new l("The Node ["+a.name+"] does not have a view handler."),c.call(y,p,r);b=f.before_request||function(){return!0};try{w=b.call(f,r)}catch(p){return c.call(f,p,r)}if(w){var d=f.on_success||function(){throw new Error("Handle.view.on_success is undefined.");},g={node:a,NODE:i,view_handler:f,on_success:d,on_exception:c},k=v[t];if(k)return n.call(f,k);s({url:t+"/view/",context:g,before_request:o,on_success:n,on_error:c})}return a}function o(){var n=this.node;console.log("Requesting view for Node{ name="+n.name+" id="+n.id+" }")}function n(n){var i=this,f=r.parse_reply(n),u,e;if(f.has_errors())return i.on_application_exception.call(i.view_handler,f.exceptions);u=f.data;e="view_"+i.node.id;u.cache&&(v[i.node.id]=u);t.getElementById(e)===null&&(r.create_style(u.style).id=e);try{i.on_success.call(i.view_handler,u,i.data)}catch(o){i.on_exception.call(i.view_handler,new l(o))}}return f}();i.prototype={exec:function(n,t,i){var r=this[n];typeof r=="function"?(t&&typeof t=="object"&&(i=t,t=null),o(r.id,t,i)):console.log(new Error("The action '"+n+"' is undefined."))}};i.view=function(n,t){n=typeof n=="string"?n:n.id;c(n,it,t)};t.addEventListener?t.addEventListener("click",b,!1):t.attachEvent("onclick",b);r.Node=i;n.NODUS=r;n.Node=i})(window,document),function(n,t,i){function o(n){var o={},i={},r=n.length,s=r,t,u,h,f,e;for(n=n.slice(0);r--;)t=n[r],i[t.id]=new Node(t);while(s--)t=n[s],f=t.name,h=t.id,u=i[t.parent_id],e=i[h],u===undefined?o[f]=e:u[f]=e;return o}function s(n){var t=n.exceptions;return t.validation=u(t,function(n){return n.type==="Validation"}),t.application=u(t,function(n){return n.type==="Application"}),t.system=u(t,function(n){return n.type==="System"}),n.has_errors=function(){return this.exceptions.length>0},n}function r(n,t){var s=f(n),i,e,u,o;switch(s){case"object":i=t||{};for(e in n)n.hasOwnProperty(e)&&(i[e]=r(n[e]));break;case"array":for(i=t||[],u=0,o=n.length;u<o;u++)i[u]=r(n[u]);break;case"date":i=new Date;i.setTime(n.getTime());break;default:i=n}return i}function h(){for(var t=arguments,u=t.length,i={},n=0;n<u;n++)r(t[n],i);return i}function l(n){for(var t=c,i=e(n),y=i.length,r=0,s="",h,u,f,a,v,l,o;r<y;)h=i.charCodeAt(r++),u=i.charCodeAt(r++),f=i.charCodeAt(r++),a=h>>2,v=(h&3)<<4|u>>4,l=(u&15)<<2|f>>6,o=f&63,isNaN(u)?l=o=64:isNaN(f)&&(o=64),s=s+t.charAt(a)+t.charAt(v)+t.charAt(l)+t.charAt(o);return s}function e(n){for(var r=n.replace(/\r\n/g,"\n"),u=r.length,f=0,i="",t;u--;)t=r.charCodeAt(f++),t<128?i+=String.fromCharCode(t):t>127&&t<2048?(i+=String.fromCharCode(t>>6|192),i+=String.fromCharCode(t&63|128)):(i+=String.fromCharCode(t>>12|224),i+=String.fromCharCode(t>>6&63|128),i+=String.fromCharCode(t&63|128));return i}function a(n){var t=i.createElement("style");return t.setAttribute("type","text/css"),t.styleSheet?t.styleSheet.cssText=n:t.insertBefore(i.createTextNode(n),null),i.getElementsByTagName("head")[0].insertBefore(t,null),t}function u(n,t){for(var f=n.length,i=0,r=[],u;i<f;i++)u=n[i],t(u)&&(r[r.length]=u);return r}var f=function(){function i(i){var r=typeof i;return i===null?"null":r==="object"||r==="function"?n[t.call(i)]||"object":r}var n={"[object Boolean]":"boolean","[object Number]":"number","[object String]":"string","[object Function]":"function","[object Array]":"array","[object Date]":"date","[object RegExp]":"regexp","[object Object]":"object","[object Error]":"error"},t=n.toString;return i}(),c="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";n.Node.build_tree=o;n.parse_reply=s;n.merge=h;n.encode_base64=l;n.encode_utf8=e;n.create_style=a;n.get_type=f}(NODUS,window,document);var NODUS;(function(n,t){function i(n){var t,f,o,s,e;if(this instanceof i==!1)return new i(n);t=this;f=t.transport=u();for(e in n)o=r(t[e]),s=n[e],n.hasOwnProperty(e)&&(o==="undefined"||o===r(s))&&(t[e]=s);var h=t.method,c=t.context||t;t.before_request.call(c,t,n);f.open(h,t.url,!0);f.onreadystatechange=function(){t.on_ready_state_change.call(t)};h==="POST"&&f.setRequestHeader("Content-type","application/x-www-form-urlencoded");f.send(t.send)}var r=n.get_type,u=t.XMLHttpRequest?function(){return new XMLHttpRequest}:function(){return new ActiveXObject("Microsoft.XMLHTTP")};i.prototype={constructor:i,url:"",method:"GET",before_request:function(){},on_complete:function(){},on_success:function(){},on_error:function(){},on_ready_state_change:function(){var n=this,t=n.transport,e=t.readyState,i,r,u=n.context||n,f;if(e!==4)return null;try{i=t.status}catch(o){return null}if(i!==200)return null;f=t.responseText;try{r=new Function("return ("+f+")")();n.on_success.call(u,r)}catch(o){n.on_error.call(u,o)}}};n.request=i})(NODUS,window,document);