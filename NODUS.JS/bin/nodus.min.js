(function(n,t){function i(){}function r(n){var o;if(n instanceof r)return n;if(typeof n=="string")return new r({id:n});var i=this,t=n.id,f=e[t];return f?f:(o=u[t],o)?(console.log("Node{ id="+t+"} was requested, but not registered on the node collection."),null):i instanceof r?(i.id=t,u[t]={data:!1,handlers:!1},e[t]=i,p(t,n),this):null}function p(n,t){var i=e[n]||new r(n);i.name=t.name;i.caption=t.caption;i.parent_id=t.parent_id;b[n]=t;w(i,t.handlers);d(i,t.actions)}function w(t,i){if(i==null||i=="")return null;var r={},u={node:t,handlers:r,shared:k};try{new Function("context","window",i)(u,n)}catch(f){throw f;}c[t.id]=r}function d(n,t){var f,r;for(t=t||[],f=n.id,r=t.length;r--;){var e=t[r],i=e.id,s=e.name,u=function(n){return function(t){o({action_id:n,data:t})}}(i),h={id:i,name:s,node_id:f,method:u};u.id=i;n[s]=u;v[i]=h}}function a(n,t){var i,r,f;if(n==null)return null;if(i=n.id,r=l[i],r)return t.call(r);if(f=function(){a(n,t)},u[i].data==!1)return nt(n,f);if(u[i].handlers==!1)return tt(n,f);l[i]=n;t.call(n)}function g(n,t){var r=n.id,e=c[r],i=e.view||{is_empty:!0},u=i.exception||e.exception||f,o,v,p,w,l,a,b;if(i.is_empty)return o=new h("The Node ["+n.name+"] does not have a view handler."),u.call(e,o);v=i.before_request||function(){return!0};p=i.on_request||function(){};try{w=v.call(i,t)}catch(o){return u.call(i,o)}if(w){if(l=it(r,i,t,u),p.call(i),a=y[r],a)return l(a);b={success:l,error:u};s(r+"/view/",null,b)}}function o(n){var p=n.action_id,g,nt,tt;if(p==null)return null;var r=v[p],w=r.name,it=r.node_id,rt=e[it];if(l[r.node_id]==null)return a(rt,function(){o(n)});var b=n.query||"",u=n.data||{},k=c[r.node_id],t=k.actions[w];if(t==null)throw new Error("The action '"+w+"' is not defined on the handler.");var ut=t.before_request||function(){return!0},ft=t.get_params||function(){return""},et=t.on_request||function(){},ot=t.on_success||function(){throw new Error("The method 'Handle.action."+w+".on_success' is undefined.");},y=t.exception||k.actions.exception||k.exception||f,d;try{d=ut.call(t,u)}catch(st){return y.call(t,st)}d&&(g=function(n){var r=i.parse_reply(n);if(r.has_errors())return y.call(t,r.exceptions);try{ot.call(t,r,u)}catch(f){y(new h(f))}},b=b||ft.call(t,u),nt="query="+encodeURIComponent(i.encode_base64(b)),et.call(t,u),tt={success:g,error:y},s("action/"+p,nt,tt))}function nt(n,t){var e=n.id,o;u[e].data=!0;o={success:function(n){var u=i.parse_reply(n);return u.has_errors()?f(u.exceptions):(r.update(e,u.data),t())}};s(e,null,o)}function tt(n,t){var r=n.id,e;u[r].handlers=!0;e={success:function(r){var u=i.parse_reply(r);if(u.has_errors())return f(u.exceptions);w(n,u.data);t()}};s(r+"/handlers",null,e)}function it(n,r,u,f){var e=r.on_success||function(){throw new Error("Handle.view.on_success is undefined.");};return function(o){var c=i.parse_reply(o),s,l;if(c.has_errors())return f(c.exceptions);s=c.data;l="view_"+n;s.cache&&(y[n]=s);t.getElementById(l)==null&&(i.create_style(s.style).id=l);try{e.call(r,s,u)}catch(a){f.call(r,new h(a))}}}function s(n,t,r){var e=r.exception||f,u={type:"POST",dataType:"json",data:t,error:function(n){e.call({},new h(n))}};i.merge(u,r);i.ajax("node/"+n,u)}function f(n){console.log("ApplicationException: ",n)}function h(n){n=typeof n=="string"?{message:n}:n;this.validation=[];this.application=[{name:"ApplicationException",message:n?n.message:""}]}function rt(n){var t=$(n.target),i=ut(t),u=ft(t);(i||u)&&(n.preventDefault(),t.blur());i?new r(i).view():u&&o({action_id:u})}function ut(n){return n.attr("node-id")||n.parent("[ node-id ]").attr("node-id")}function ft(n){return n.attr("action-id")||n.parent("[ action-id ]").attr("action-id")}var e={},b={},v={},c={},u={},k={},y={},l={};r.prototype={view:function(n){var t=this,i=function(){g(t,n)};return a(t,i),t},exec:function(n){var i=this[n],f;if(i){var r=Array.prototype.slice.call(arguments),t=r[1],u=r[2];t&&typeof t=="object"&&(u=t,t=null);f={action_id:i.id,query:t,data:u};o(f)}}};r.update=function(n,t){p(n,t)};i.Node=r;$(n.document).click(rt);n.NODUS=i;n.Node=r})(window,document),function(n,t,i){function e(n){var t={},i=n.slice(0);return u(t,i),t}function u(n,t){for(var f=n.id,r=t.length,i;r--;)i=new Node(t[r]),i.parent_id==f&&(n[i.name]=i,u(i,t))}function o(n){var t=n.exceptions;return t.validation=$.grep(t,function(n){return n.type==="Validation"}),t.application=$.grep(t,function(n){return n.type==="Application"}),t.system=$.grep(t,function(n){return n.type==="System"}),n.has_errors=function(){return this.exceptions.length>0},n}function r(n,t){var o=s(n),i,f,u,e;switch(o){case"object":i=t||{};for(f in n)n.hasOwnProperty(f)&&(i[f]=r(n[f]));break;case"array":for(i=t||[],u=0,e=n.length;u<e;u++)i[u]=r(n[u]);break;case"date":i=new Date;i.setTime(n.getTime());break;default:i=n}return i}function h(){for(var t=arguments,u=t.length,i={},n=0;n<u;n++)r(t[n],i);return i}function l(n){for(var t=c,i=f(n),y=i.length,r=0,s="",h,u,e,a,v,l,o;r<y;)h=i.charCodeAt(r++),u=i.charCodeAt(r++),e=i.charCodeAt(r++),a=h>>2,v=(h&3)<<4|u>>4,l=(u&15)<<2|e>>6,o=e&63,isNaN(u)?l=o=64:isNaN(e)&&(o=64),s=s+t.charAt(a)+t.charAt(v)+t.charAt(l)+t.charAt(o);return s}function f(n){for(var r=n.replace(/\r\n/g,"\n"),u=r.length,f=0,i="",t;u--;)t=r.charCodeAt(f++),t<128?i+=String.fromCharCode(t):t>127&&t<2048?(i+=String.fromCharCode(t>>6|192),i+=String.fromCharCode(t&63|128)):(i+=String.fromCharCode(t>>12|224),i+=String.fromCharCode(t>>6&63|128),i+=String.fromCharCode(t&63|128));return i}var s=function(){function i(i){var r=typeof i;return i==null?"null":r==="object"||r==="function"?n[t.call(i)]||"object":r}var n={"[object Boolean]":"boolean","[object Number]":"number","[object String]":"string","[object Function]":"function","[object Array]":"array","[object Date]":"date","[object RegExp]":"regexp","[object Object]":"object","[object Error]":"error"},t=n.toString;return i}(),c="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";n.build_node_tree=e;n.parse_reply=o;n.merge=h;n.encode_base64=l;n.encode_utf8=f}(NODUS,window,document);